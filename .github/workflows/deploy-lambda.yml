name: Deploy Lambda to AWS

on:
  push:
    branches:
      - main
    paths:
      - 'lambda/**'
      - 'cloudformation/**'
      - '.github/workflows/deploy-lambda.yml'
  workflow_dispatch:
    inputs:
      stack_name:
        description: 'CloudFormation stack name'
        required: true
        default: 'HelloWorldLambdaStack'
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - update
          - delete

env:
  AWS_REGION: us-east-1
  LAMBDA_FUNCTION_NAME: HelloWorldLambda
  S3_BUCKET: lambda-deployments-${{ github.repository_owner }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.action != 'delete'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd lambda
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt -t .
          fi

      - name: Package Lambda function
        run: |
          cd lambda
          zip -r ../lambda-deployment.zip . -x "*.pyc" -x "__pycache__/*"
          cd ..
          ls -lh lambda-deployment.zip

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create S3 bucket if it doesn't exist
        run: |
          if ! aws s3api head-bucket --bucket ${{ env.S3_BUCKET }} 2>/dev/null; then
            if [ "${{ env.AWS_REGION }}" = "us-east-1" ]; then
              aws s3api create-bucket --bucket ${{ env.S3_BUCKET }} --region ${{ env.AWS_REGION }}
            else
              aws s3api create-bucket --bucket ${{ env.S3_BUCKET }} --region ${{ env.AWS_REGION }} \
                --create-bucket-configuration LocationConstraint=${{ env.AWS_REGION }}
            fi
          fi

      - name: Upload Lambda package to S3
        run: |
          aws s3 cp lambda-deployment.zip s3://${{ env.S3_BUCKET }}/lambda-deployment.zip

      - name: Deploy CloudFormation stack
        run: |
          STACK_NAME="${{ github.event.inputs.stack_name || 'HelloWorldLambdaStack' }}"

          # Check if stack exists
          if aws cloudformation describe-stacks --stack-name $STACK_NAME 2>/dev/null; then
            echo "Updating existing stack..."
            aws cloudformation update-stack \
              --stack-name $STACK_NAME \
              --template-body file://cloudformation/deploy-lambda.yaml \
              --parameters \
                ParameterKey=FunctionName,ParameterValue=${{ env.LAMBDA_FUNCTION_NAME }} \
                ParameterKey=S3Bucket,ParameterValue=${{ env.S3_BUCKET }} \
                ParameterKey=S3Key,ParameterValue=lambda-deployment.zip \
              --capabilities CAPABILITY_NAMED_IAM || echo "No updates to perform"

            aws cloudformation wait stack-update-complete --stack-name $STACK_NAME || true
          else
            echo "Creating new stack..."
            aws cloudformation create-stack \
              --stack-name $STACK_NAME \
              --template-body file://cloudformation/deploy-lambda.yaml \
              --parameters \
                ParameterKey=FunctionName,ParameterValue=${{ env.LAMBDA_FUNCTION_NAME }} \
                ParameterKey=S3Bucket,ParameterValue=${{ env.S3_BUCKET }} \
                ParameterKey=S3Key,ParameterValue=lambda-deployment.zip \
              --capabilities CAPABILITY_NAMED_IAM

            aws cloudformation wait stack-create-complete --stack-name $STACK_NAME
          fi

      - name: Get Lambda function details
        run: |
          STACK_NAME="${{ github.event.inputs.stack_name || 'HelloWorldLambdaStack' }}"
          echo "Stack Outputs:"
          aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs' --output table

  delete:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'delete'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Delete CloudFormation stack
        run: |
          STACK_NAME="${{ github.event.inputs.stack_name }}"

          if aws cloudformation describe-stacks --stack-name $STACK_NAME 2>/dev/null; then
            echo "Deleting stack $STACK_NAME..."
            aws cloudformation delete-stack --stack-name $STACK_NAME
            aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME
            echo "Stack deleted successfully"
          else
            echo "Stack $STACK_NAME does not exist"
          fi

      - name: Clean up S3 objects (optional)
        run: |
          echo "Cleaning up S3 bucket..."
          aws s3 rm s3://${{ env.S3_BUCKET }}/lambda-deployment.zip || true
